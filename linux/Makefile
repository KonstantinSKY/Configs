.PHONY: all mount create_subvolume defrag

LABEL = Work
DIR = Work
FS_TYPE = btrfs
SUBVOL = @work
OPTIONS = subvol=$(SUBVOL),compress=zstd,noatime
DUMP = 0
PASS = 2
FSTAB = /etc/fstab
UUID = $(shell sudo blkid -s UUID -o value $$(sudo findfs LABEL=$(LABEL)))
HOME_DIR = $(HOME)/$(DIR)

all: mount

mount: create_subvolume
	@echo "ğŸ” Searching for device with label '$(LABEL)'..."
	@if [ -z "$(UUID)" ]; then echo "âŒ Device with label '$(LABEL)' not found!"; exit 1; fi
	@echo "âœ… UUID found: $(UUID)"

	@echo "ğŸ“ Creating directory $(HOME_DIR) if it doesn't exist..."
	mkdir -p "$(HOME_DIR)"

	@echo "ğŸ“Œ Checking if entry already exists in $(FSTAB)..."
	@if grep -q "$(UUID)" $(FSTAB); then \
		echo "âš ï¸  Entry already exists in $(FSTAB). Skipping..."; \
	else \
		echo "ğŸ“¦ Backing up $(FSTAB) -> $(FSTAB).bak"; \
		sudo cp $(FSTAB) $(FSTAB).bak; \
		echo "ğŸ“¥ Adding new entry to $(FSTAB)..."; \
		echo "UUID=$(UUID) $(HOME_DIR) $(FS_TYPE) $(OPTIONS) $(DUMP) $(PASS)" | sudo tee -a $(FSTAB); \
	fi

	@echo "ğŸ”„ Reloading systemd daemon..."
	sudo systemctl daemon-reexec

	@echo "ğŸ“¦ Mounting all entries..."
	sudo mount -a || echo "âŒ Mount failed. Please check /etc/fstab or subvolume existence."


	@echo "ğŸ“‚ Verifying mount status..."
	@if mount | grep -q "$(HOME_DIR)"; then \
		echo "âœ… Mounted successfully at $(HOME_DIR)"; \
	else \
		echo "âŒ Mount failed. Check /etc/fstab and system logs."; \
		exit 1; \
		fi

	@echo "ğŸ“‚ Listing contents of $(HOME_DIR)..."
	@ls -la "$(HOME_DIR)"

	@echo "ğŸ” Setting ownership and permissions for $(HOME_DIR)..."
	sudo chown -R $(USER):$(USER) "$(HOME_DIR)"
	sudo chmod -R 700 "$(HOME_DIR)"

	@echo "âœ… Done. $(DIR) is mounted with options: $(OPTIONS)."

# Automatically create subvolume if it doesn't exist
create_subvolume:
	@echo "ğŸ” Checking if subvolume $(SUBVOL) exists on $(LABEL)..."
	@mountpoint -q /mnt || sudo mount -o subvolid=5,ro LABEL=$(LABEL) /mnt
	@if ! sudo btrfs subvolume list /mnt | grep -q "$(SUBVOL)"; then \
		echo "â• Creating subvolume $(SUBVOL)..."; \
		sudo mount -o subvolid=5 LABEL=$(LABEL) /mnt; \
		sudo btrfs subvolume create /mnt/$(SUBVOL); \
		sudo umount /mnt; \
	else \
		echo "âœ… Subvolume $(SUBVOL) already exists."; \
		sudo umount /mnt || true; \
	fi

# Manual defragmentation with compression
defrag:
	@echo "âš™ï¸  Defragmenting and recompressing $(HOME_DIR) using zstd..."
	sudo btrfs filesystem defragment -r -v -czstd "$(HOME_DIR)"
	@echo "âœ… Defragmentation completed."
