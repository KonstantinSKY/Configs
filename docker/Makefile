MANJARO_MAKEFILE := $(HOME)/Configs/manjaro/Makefile

.PHONY: help h install i setup set version v status s


help h:
	@echo "ğŸ›   Available targets:"
	@echo "  make install / i     Install Docker and its ecosystem"
	@echo "  make setup  / set    Enable and start Docker, add user to group"
	@echo "  make version / v     Show installed Docker versions"
	@echo "  make status  / s     Show Docker daemon status and running containers"
	@echo "------------------------------------------------------------"

install i:
	@echo "ğŸ³ Installing Docker ecosystem using universal Manjaro Makefile..."
	@make -f $(MANJARO_MAKEFILE) install docker docker-compose docker-buildx
	@$(MAKE) version
	@$(MAKE) setup

setup set:
	@echo "ğŸ”§ Enabling and starting Docker daemon..."
	@sudo systemctl enable docker
	@sudo systemctl start docker
	@echo "------------------------------------------------------------"
	@echo "ğŸ‘¤ Adding user '$(USER)' to 'docker' group..."
	@sudo usermod -aG docker $(USER)
	@echo "------------------------------------------------------------"
	@$(MAKE) status
	@echo "âš ï¸  Please reboot or run 'newgrp docker' to apply group changes."
	@echo "âœ… Docker setup complete."

version v:
	@echo "ğŸ” Checking installed Docker versions"
	@echo "ğŸ³ Docker version:"
	@docker --version || echo "âŒ Docker not found"
	@echo "ğŸ³ Docker compose version:"
	@docker compose version || echo "âŒ docker compose not found"
	@echo "ğŸ³ Docker buildx version:"
	@docker buildx version || echo "âŒ docker buildx not found"
	@echo "------------------------------------------------------------"

status s: version group
	@echo "ğŸ” Checking Docker status"
	@echo "ğŸ” Checking Docker daemon status..."
	@sudo systemctl status docker --no-pager || echo "âŒ Docker service not found"
	@echo "------------------------------------------------------------"
	@echo "ğŸ”„ Docker info summary:"
	@docker info --format '  - Containers: {{.Containers}} (running: {{.ContainersRunning}}), Images: {{.Images}}, Storage Driver: {{.Driver}}' || echo "âŒ docker info failed"
	@echo "------------------------------------------------------------"
	@echo "ğŸ“¦ Currently running containers:"
	docker ps
	@echo "------------------------------------------------------------"
	@docker ps --format '  - {{.Names}} ({{.Image}}) â€” Up: {{.Status}}' || echo "âŒ docker ps failed"
	@echo "------------------------------------------------------------"

group g:
	@echo "ğŸ”’ Checking user group access:"
	@if id -nG "$(USER)" | grep -qw docker; then \
		echo "âœ… User '$(USER)' is in the 'docker' group"; \
	else \
		echo "âŒ User '$(USER)' is NOT in the 'docker' group. Run 'sudo usermod -aG docker $(USER)'"; \
	fi
	@echo "------------------------------------------------------------"
