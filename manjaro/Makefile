.PHONY: setup mirrors pacman-update install-yay enable-aur update

# Main target
setup: mirrors pacman-update install-yay yay-update enable-aur
	@echo "âœ… Manjaro i3 setup complete!"

# mirrors update
mirrors:
	@echo "ğŸ”„ Updating mirrors..."
	sudo pacman-mirrors --fasttrack && sudo pacman -Syy

pacman-update:
	@echo "â¬†ï¸  Running full system upgrade..."
	sudo pacman -Syu --noconfirm

yay-update:
	@echo "â¬†ï¸  Updating AUR and system packages with yay..."
	@yay -Syu --noconfirm

enable-aur:
	@echo "âš™ï¸  Enabling AUR support in pamac (if applicable)..."
	@if command -v pamac >/dev/null 2>&1; then \
		pamac config --enable-aur; \
	else \
		echo "â„¹ï¸  pamac not found, skipping AUR GUI enabling..."; \
	fi
update:
	@echo "â¬†ï¸  Full update of AUR and system packages via yay..."
	yay -Syyu --noconfirm --answerclean None --answerdiff None
	@echo "-------------------------------------------------------------------------------"
	@echo "ğŸ§¹ Removing unused dependencies..."
	yay -Rns $$(pacman -Qtdq 2>/dev/null) || echo "âœ… No unused dependencies found"
	@echo "-------------------------------------------------------------------------------"
	@echo "ğŸ§¼ Cleaning cache..."
	yay -Sc --noconfirm
	@echo "âœ… Update completed successfully!"
	@echo "-------------------------------------------------------------------------------"

install-base:
	@echo "ğŸ“¦ Installing essential packages via yay..."
	yay -S --needed --noconfirm \
		base-devel \
		fzf \
		git \
		curl \
		wget \
		man-db \
		man-pages \
		file \
		which \
		manjaro-settings-manager \
		materia-gtk-theme \
		matcha-gtk-theme \
		lsof \
		nmap \
		alsa-utils \
		pulseaudio \
		noto-fonts \
		noto-fonts-emoji \
		ttf-jetbrans-mono \
		ttf-hack \
		ttf-hack-nerd



	@echo "âœ… Base packages installed via yay."

check:
	@echo "ğŸ” Starting full system diagnostic..."
	@echo ""

	@echo "ğŸ‘¤ User and Host Info:"
	@echo "User: $$(whoami)"
	@echo "Host: $$(hostname)"
	@echo "Home Dir: $$HOME"
	@echo ""

	@echo "ğŸ•’ Uptime and Load:"
	@uptime
	@echo ""

	@echo "ğŸ§  Memory and Swap Usage:"
	@free -h
	@echo ""

	@echo "ğŸ’¾ Disk Usage for / and /var:"
	@df -hT -x squashfs -x tmpfs -x devtmpfs
	@echo ""

	@echo "ğŸ”Œ Network Interfaces:"
	@ip -brief address
	@echo ""

	@echo "ğŸŒ Open Network Ports:"
	@ss -tuln
	@echo ""

	@echo "ğŸ“Š Top Processes Snapshot:"
	@top -bn1 | head -15
	@echo ""

	@echo "âš™ï¸  Systemd Services with Errors:"
	@systemctl --failed --no-pager
	@echo ""

	@echo "ğŸ‘» Zombie or Suspicious Processes:"
	@ps -eo pid,ppid,stat,cmd | awk '$3 ~ /^Z/ { print }' || echo "âœ”ï¸  No zombie processes found"
	@echo ""

	@echo "ğŸ” Running Processes as root:"
	@ps -U root -u root u
	@echo ""

	@echo "ğŸ“„ Recent System Errors (priority 3, current boot):"
	@journalctl -p 3 -xb -n 20 || echo "âœ”ï¸  No recent critical errors"
	@echo ""

	@echo "ğŸš¨ Kernel Critical Logs (OOM, segfaults, panics):"
	@journalctl -k -p 0..3 | grep -Ei 'Out of memory|Kernel panic|segfault' || echo "âœ”ï¸  No kernel-level issues detected"
	@echo ""

	@echo "â±ï¸  Active Timers (Cron/Systemd):"
	@systemctl list-timers --all --no-pager | head -15
	@echo ""

	@echo "ğŸ”‘ Sudo Group Members:"
	@grep '^sudo:' /etc/group || echo "â„¹ï¸  No 'sudo' group found"
	@echo ""

	@echo "ğŸ”¥ Temperature Sensors (if available):"
	@command -v sensors >/dev/null && sensors || echo "â„¹ï¸  'sensors' command not available"
	@echo ""

	@echo "ğŸ³ Docker Status:"
	@if command -v docker >/dev/null; then \
		echo "Docker is installed."; \
		docker info --format='Version: {{.ServerVersion}}, OS: {{.OperatingSystem}}'; \
		systemctl is-active docker && echo "âœ”ï¸  Docker is running" || echo "âŒ Docker is not running"; \
		echo "Running containers:"; \
		docker ps --format='  - {{.Names}} ({{.Image}})' || echo "âŒ Failed to list containers"; \
	else \
		echo "â„¹ï¸  Docker is not installed."; \
	fi
	@echo ""

	@echo "\nğŸ§ª Testing Dunst Notification (without emoji):"
	@notify-send "Notification test" "Dunst is working!"

	@echo "âœ… System check completed."
