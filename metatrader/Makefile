.PHONY: new run

METATRADERS_DIR := $(HOME)/Work/MetaTraders
MT4_DEV_DIR     := $(METATRADERS_DIR)/MT4

# MQL4 structure
MQL4_DIR        := $(MT4_DEV_DIR)/MQL4
INCLUDE_DIR     := $(MQL4_DIR)/Include
EXPERTS_DIR     := $(MQL4_DIR)/Experts
PROJECTS_MQL    := $(MQL4_DIR)/Projects

# Physical place where your projects live
PROJECTS_DIR    := $(METATRADERS_DIR)/Projects

# Templates live INSIDE MT4 dir (as —Ç—ã —Å–∫–∞–∑–∞–ª)
TEMPLATE_DIR    := $(MT4_DEV_DIR)/Templates
TEMPLATE_EXPERT := $(TEMPLATE_DIR)/expert_template.mq4  # Expert template name

new:
	@read -p "üìõ Enter project name: " PROJECT_NAME; \
	if [ -z "$$PROJECT_NAME" ]; then \
		echo "‚ùå Project name cannot be empty!"; exit 1; \
	fi; \
	PROJECT_DIR="$(PROJECTS_DIR)/$$PROJECT_NAME"; \
	LINK_IN_INCLUDE="$(INCLUDE_DIR)/$$PROJECT_NAME"; \
	LINK_EXPERT="$(EXPERTS_DIR)/$$PROJECT_NAME.mq4"; \
	\
	# --- sanity checks ---
	if [ ! -d "$(MQL4_DIR)" ]; then \
		echo "‚ùå MQL4 dir not found: $(MQL4_DIR)"; exit 1; \
	fi; \
	if [ ! -f "$(TEMPLATE_EXPERT)" ]; then \
		echo "‚ùå Expert template not found: $(TEMPLATE_EXPERT)"; exit 1; \
	fi; \
	\
	# --- create real project dir (outside MQL4) ---
	if [ -e "$$PROJECT_DIR" ]; then \
		echo "‚ùå Project already exists: $$PROJECT_DIR"; exit 1; \
	fi; \
	echo "üìÅ Creating project: $$PROJECT_DIR"; \
	mkdir -p "$$PROJECT_DIR"; \
	\
	# --- link Include into project (read-only from MT4 Include) ---
	if [ ! -L "$$PROJECT_DIR/Include" ]; then \
		echo "üîó Linking Include ‚Üí project"; \
		ln -s "$(INCLUDE_DIR)" "$(PROJECT_DIR)"; \
	fi; \
	\
	# --- link project into MQL4/Projects/<name> ---
	# (MetaEditor –≤–∏–¥–∏—Ç –ø—Ä–æ–µ–∫—Ç –≤ MQL4/Projects, –Ω–æ –¥–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ —Ç–≤–æ—ë–º PROJECTS_DIR)
	if [ -e "$$LINK_IN_INCLUDE" ]; then \
		echo "‚ùå Path already exists: $$LINK_IN_PROJECTS"; exit 1; \
	fi; \
	echo "üîó Linking project into MQL4/Projects: $$LINK_IN_INCLUDE ‚Üí $$PROJECT_DIR"; \
	ln -s "$$PROJECT_DIR" "$$LINK_IN_INCLUDE"; \
	\
	# --- main linking: template ‚Üí MQL4/Experts/<ProjectName>.mq4 (—Ç–æ, —á—Ç–æ –∫–æ–º–ø–∏–ª–∏—Ç—Å—è) ---
	if [ -e "$$LINK_EXPERT" ]; then \
		echo "‚ùå Expert already exists: $$LINK_EXPERT"; exit 1; \
	fi; \
	echo "üîó Linking expert template ‚Üí Experts: $$LINK_EXPERT ‚Üí $(TEMPLATE_EXPERT)"; \
	ln -s "$(TEMPLATE_EXPERT)" "$$LINK_EXPERT"; \
	\
	echo "‚úÖ Project '$$PROJECT_NAME' created and wired to MQL4."
