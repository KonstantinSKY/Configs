# Git & GitHub Project Manager
SHELL := /bin/bash

.PHONY: help h setup s init i create_repo cr delete_repo dr force_ssh fs commit c full_commit fc install in git

GITHUB_USER  := KonstantinSKY
GITHUB_EMAIL := sky012877@gmail.com

help h:
	@echo "ğŸ› ï¸  Git & GitHub Project Manager"
	@echo ""
	@echo "Targets:"
	@echo "  help | h            Show this help message"
	@echo "  install | in        Install git and GitHub CLI (gh) via yay"
	@echo "  setup | s           Configure global git settings (username, email, branch, ssh)"
	@echo "  init | i            Initialize local git repo with main branch and first commit"
	@echo "  create_repo | cr    Create private GitHub repo and link it to local folder"
	@echo "  delete_repo | dr    Delete GitHub repo by name (or current folder name)"
	@echo "  force_ssh | fs      Force remote 'origin' to SSH and push main branch"
	@echo "  commit | c          Commit and push all changes with a message"
	@echo "  full_commit | fc    Pull (rebase), commit and push changes"
	@echo "  git                 Auto-detect changes, generate message via Gemini, commit & push"
	@echo "-------------------------------------------------------------------"

install in:
	@echo "ğŸ”„ Updating system packages..."
	yay -Syu --noconfirm
	@echo "ğŸ“¦ Installing git and GitHub CLI (gh)..."
	yay -S --noconfirm git github-cli
	@echo "âœ… Installation complete:"
	@git --version
	@gh --version
	@echo "-------------------------------------------------------------------"

setup s:
	@echo "ğŸ”§ Configuring Git global settings..."
	@git config --global user.name "$$(whoami)"
	@git config --global user.email "$(GITHUB_EMAIL)"
	@git config --global init.defaultBranch main
	@git config --global pull.rebase true
	@git config --global pull.ff only
	@echo "âœ… Git configuration complete:"
	@git config --global --get user.name
	@git config --global --get user.email
	@git config --global --get init.defaultBranch
	@git config --global --get pull.rebase
	@git config --global --get pull.ff
	@echo "-------------------------------------------------------------------"

init i:
	@echo "ğŸ—‚ï¸  Initializing local Git repository..."
	git init -b main
	git add .
	git commit -m "Initial commit" || echo "â„¹ï¸ Nothing to commit"
	@echo "âœ… Git repository initialized with 'main' branch."
	@echo "-------------------------------------------------------------------"

create_repo cr:
	@project=$(word 2, $(MAKECMDGOALS)); \
	if [ -z "$$project" ]; then \
		read -p "ğŸ“› Enter GitHub repository name: " project_input; \
		project=$$project_input; \
	fi; \
	project_name=$$(basename "$$project"); \
	if [ -z "$$project_name" ]; then echo "âŒ Error: repository name is required."; exit 1; fi; \
	echo "ğŸ” Checking GitHub CLI authentication..."; \
	if ! gh auth status >/dev/null 2>&1; then \
		echo "ğŸ”‘ Not logged in. Launching GitHub login..."; \
		gh auth login; \
	fi; \
	echo "ğŸŒ Creating private repository '$$project_name' on GitHub..."; \
	gh repo create $$project_name --private --source=. --remote=origin; \
	echo "âœ… Remote 'origin' created."
	@echo "-------------------------------------------------------------------"

delete_repo dr:
	@project=$(word 2, $(MAKECMDGOALS)); \
	if [ -z "$$project" ]; then project=$$(basename $$PWD); fi; \
	if [ -z "$$project" ]; then echo "âŒ Error: repository name is required."; exit 1; fi; \
	echo "ğŸ—‘ï¸  Deleting repo: $$project on GitHub..."; \
	gh repo delete $(GITHUB_USER)/$$project
	@echo "-------------------------------------------------------------------"

force_ssh fs:
	@project=$(word 2, $(MAKECMDGOALS)); \
	if [ -z "$$project" ]; then project=$$(basename "$$PWD"); fi; \
	project_name=$$(basename "$$project"); \
	if [ -z "$$GITHUB_USER" ]; then \
		GITHUB_USER=$$(gh api user --jq '.login'); \
	fi; \
	echo "ğŸ” Remote origin â†’ SSH: git@github.com:$$GITHUB_USER/$$project_name.git"; \
	git remote set-url origin git@github.com:$$GITHUB_USER/$$project_name.git; \
	git branch --set-upstream-to=origin/main main 2>/dev/null || echo "â„¹ï¸ Could not set upstream"; \
	git push -u origin main || echo "âš ï¸ Push failed"
	@echo "-------------------------------------------------------------------"

commit c:
	@message="$(shell echo $(wordlist 2, 999, $(MAKECMDGOALS)))"; \
	if [ -z "$$message" ]; then message="no message"; fi; \
	echo "ğŸ”§ Committing with message: '$$message'"; \
	git add .;
	git commit -m "$$message" || echo "â„¹ï¸ Nothing to commit"; \
	git push || echo "âš ï¸ Push failed"; \
	echo "âœ… Commit + push complete"
	@echo "-------------------------------------------------------------------"

full_commit fc:
	@message="$(wordlist 2, 999, $(MAKECMDGOALS))"; \
	if [ -z "$$message" ]; then message="no_message"; fi; \
	echo "-------------------------------------------------------------------"; \
	git status -s || true; \
	echo "-------------------------------------------------------------------"; \
	echo "â• Adding all changes..."; \
	git add -A; \
	echo "-------------------------------------------------------------------"; \
	echo "ğŸ“ Committing with message: '$$message'"; \
	git commit -m "$$message" || echo "â„¹ï¸ Nothing to commit"; \
	echo "-------------------------------------------------------------------"; \
	echo "ğŸ”„ Pulling latest changes with rebase..."; \
	git pull --rebase origin main || echo "âš ï¸ Pull failed â€” maybe repo is new"; \
	echo "-------------------------------------------------------------------"; \
	echo "ğŸš€ Pushing to origin/main..."; \
	git push origin main || echo "âš ï¸ Push failed"; \
	git status -s || true; \
	echo "âœ… Full commit cycle complete"; \
	echo "-------------------------------------------------------------------"

git:
	@echo "ğŸ” Checking status..."
	@status=$$(git status --porcelain); \
	if [ -z "$$status" ]; then \
		echo "âœ¨ No changes to commit."; \
	else \
		echo "ğŸ“„ Current status:"; \
		git status -s; \
		echo "ğŸš€ Staging changes..."; \
		git add .; \
		echo "ğŸ¤– Generating commit message via Gemini..."; \
		MESSAGE=$$(git diff --staged | gemini -p "Generate a concise, professional git commit message in English for these changes. Respond ONLY with the message text, no quotes or markdown." 2>/dev/null); \
		if [ -z "$$MESSAGE" ]; then \
			MESSAGE="Update: automatic sync (Gemini message generation failed)"; \
		fi; \
		echo "ğŸ“ Message: $$MESSAGE"; \
		git commit -m "$$MESSAGE"; \
		git push; \
		echo "âœ… Done!"; \
	fi

%:
	@: