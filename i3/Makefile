.PHONY: help setup clean

## ---------------------------
## üß© i3 configuration paths
## ---------------------------
I3_CONF_DIR        := $(HOME)/.config/i3
OLD_I3_DIR         := $(HOME)/.i3
SOURCE_I3_CONFIG   := $(HOME)/Work/Configs/i3

## ---------------------------
## üß© i3 main config files
## ---------------------------
I3_TARGET_CONFIG   := $(I3_CONF_DIR)/config
I3_SOURCE_CONFIG   := $(SOURCE_I3_CONFIG)/config

## ---------------------------
## üß© i3 monitor directory links
## ---------------------------
I3_TARGET_MONITOR_LINK     := $(I3_CONF_DIR)/monitor
I3_SOURCE_MONITOR_LAPTOP   := $(SOURCE_I3_CONFIG)/laptop
I3_SOURCE_MONITOR_DESKTOP  := $(SOURCE_I3_CONFIG)/desktop

help:
	@echo "üìò Available targets:"
	@echo "  setup   ‚Äì Set up i3 configuration (create folder, remove old one, link new config)"

setup:
	@echo "üîç Detecting i3 version..."
	@if command -v i3 >/dev/null 2>&1; then \
		i3 --version; \
	else \
		echo "‚ùå i3 is not installed. Aborting."; \
		exit 1; \
	fi
	@echo "------------------------------------------------------------"

	@echo "üîç Validating source config file..."
	@echo "üìÑ Role   : Main i3 config"
	@echo "üìÑ Source : $(I3_SOURCE_CONFIG)"
	@if [ ! -f "$(I3_SOURCE_CONFIG)" ]; then \
		echo "‚ùå Main config file not found: $(I3_SOURCE_CONFIG)"; \
		exit 1; \
	fi

	@echo "+ i3 -C -c $(I3_SOURCE_CONFIG)"
	@if ! i3 -C -c "$(I3_SOURCE_CONFIG)" >/dev/null 2>&1; then \
		echo "‚ùå Main config is invalid! Please fix errors before continuing."; \
		i3 -C -c "$(I3_SOURCE_CONFIG)"; \
		exit 1; \
	else \
		echo "‚úÖ Main config is valid: $(I3_SOURCE_CONFIG)"; \
	fi
	@echo "------------------------------------------------------------"

	@echo "üìÅ Creating config directory..."
	@mkdir -p "$(I3_CONF_DIR)"
	@echo "------------------------------------------------------------"

	@echo "üîó Linking main config:"
	@echo "‚Üí Target : $(I3_TARGET_CONFIG)"
	@echo "‚Üí Source : $(I3_SOURCE_CONFIG)"
	@ln -sf "$(I3_SOURCE_CONFIG)" "$(I3_TARGET_CONFIG)"
	@echo "------------------------------------------------------------"

	@echo "üíª Detecting system type and linking monitor directory..."
	@sh -c '\
		if command -v upower >/dev/null && upower -e | grep -q BAT; then \
			echo "üñ•Ô∏è  Laptop detected."; \
			MONITOR_DIR="$(I3_SOURCE_MONITOR_LAPTOP)"; \
		else \
			echo "üñ•Ô∏è  Desktop detected."; \
			MONITOR_DIR="$(I3_SOURCE_MONITOR_DESKTOP)"; \
		fi; \
		echo "------------------------------------------------------------"; \
		echo "üîó Linking monitor directory:"; \
		echo "‚Üí Target : $(I3_TARGET_MONITOR_LINK)"; \
		echo "‚Üí Source : $$MONITOR_DIR"; \
		ln -sfn "$$MONITOR_DIR" "$(I3_TARGET_MONITOR_LINK)"; \
	'
	@echo "------------------------------------------------------------"

	@echo "üîç Final validation of full i3 config..."
	@if ! i3 -C -c "$(I3_TARGET_CONFIG)" >/dev/null 2>&1; then \
		echo "‚ùå Final config is invalid! Rolling back symlinks."; \
		rm -f "$(I3_TARGET_CONFIG)" "$(I3_TARGET_MONITOR_LINK)"; \
		exit 1; \
	else \
		echo "‚úÖ Final config is valid and active."; \
	fi
	@echo "------------------------------------------------------------"

	@echo "üßπ Removing legacy directory (if exists): $(OLD_I3_DIR)"
	@rm -rf "$(OLD_I3_DIR)"
	@echo "‚úÖ Setup complete!"
